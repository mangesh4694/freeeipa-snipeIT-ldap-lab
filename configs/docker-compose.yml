version: '3.8'

# =============================================================================
# Docker Compose â€” Snipe-IT + MySQL
# Project: FreeIPA + Snipe-IT LDAP Integration Lab
# =============================================================================
# USAGE:
#   docker compose up -d
#
# NOTE: Copy snipeit-ldap.env to .env and fill in your values before starting.
# =============================================================================

services:

  # MySQL Database for Snipe-IT
  snipeit-db:
    image: mysql:8.0
    container_name: snipeit-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-changeme_root}
      MYSQL_DATABASE: snipeit
      MYSQL_USER: snipeit
      MYSQL_PASSWORD: ${DB_PASSWORD:-changeme_db}
    volumes:
      - snipeit-db-data:/var/lib/mysql
    networks:
      - snipeit-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 10s
      retries: 5
      interval: 10s

  # Snipe-IT Application
  snipeit:
    image: snipe/snipe-it:latest
    container_name: snipeit
    restart: unless-stopped
    depends_on:
      snipeit-db:
        condition: service_healthy
    ports:
      - "8080:80"
    environment:
      # Application
      APP_ENV: production
      APP_DEBUG: "false"
      APP_KEY: ${APP_KEY}
      APP_URL: ${APP_URL:-http://localhost:8080}
      APP_TIMEZONE: ${APP_TIMEZONE:-UTC}
      APP_LOCALE: en-US

      # Database
      DB_CONNECTION: mysql
      DB_HOST: snipeit-db
      DB_DATABASE: snipeit
      DB_USERNAME: snipeit
      DB_PASSWORD: ${DB_PASSWORD:-changeme_db}

      # Mail
      MAIL_DRIVER: ${MAIL_DRIVER:-log}
      MAIL_HOST: ${MAIL_HOST:-localhost}
      MAIL_PORT: ${MAIL_PORT:-587}
      MAIL_FROM_ADDR: ${MAIL_FROM_ADDR:-snipeit@theonetech.lab}
      MAIL_FROM_NAME: "Snipe-IT"

    extra_hosts:
      # Ensures the container can resolve FreeIPA by hostname
      - "ipa.theonetech.lab:192.168.1.10"

    volumes:
      - snipeit-app-data:/var/lib/snipeit
      # Mount FreeIPA CA cert for LDAPS support
      - /usr/local/share/ca-certificates/ipa-ca.crt:/usr/local/share/ca-certificates/ipa-ca.crt:ro

    networks:
      - snipeit-net

# Named volumes for persistence
volumes:
  snipeit-db-data:
    driver: local
  snipeit-app-data:
    driver: local

# Internal network
networks:
  snipeit-net:
    driver: bridge
